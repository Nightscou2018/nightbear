<!doctype html>
<html manifest="entries.manifest.appcache">

    <head>
        <meta charset="utf-8">
        <title>Nightbear Entries</title>
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">

        <style>
            body {
                font-size: 1em;
                color: #000;
                background: #fafafa;
                font-weight: 300;
                text-rendering: optimizelegibility;
                margin: 0;
                padding: 0 30px;
                -webkit-touch-callout: none;
                -webkit-user-select: none;
                -khtml-user-select: none;
                -moz-user-select: none;
                -ms-user-select: none;
                user-select: none;
            }

            button {
                display: block;
                font-size: 20px;
                padding: 15px;
                margin: 20px;
            }

            #visibility {
                font-weight: bold;
                font-size: 16px;
                color: red;
                display: none;
            }
        </style>
    </head>

    <body>

        <script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/pouchdb/5.3.0/pouchdb.js"></script>

        <pre id="status-down" style="font-weight: bold;">status-down ???</pre>
        <pre id="status-up" style="font-weight: bold;">status-up ???</pre>
        <pre id="visibility">PAGE BECAME VISIBLE</pre>
        <pre id="info">???</pre>
        <ul></ul>

        <p>UI_VERSION = <span id="ui-version">version???</span></p>
        <p>DB_VERSION = <span id="db-version">version???</span></p>

        <button id="add-carbs">Add carbs</button>
        <button id="add-insulin">Add insulin</button>
        <button id="clear-url">Clear remote URL</button>

        <script>
            $(function() {

                var UI_VERSION = 'v8'; // match this with the manifest.appcache file
                var DB_VERSION = 'v5'; // increment this to force a re-sync

                $('#ui-version').text(UI_VERSION);
                $('#db-version').text(DB_VERSION);
                $('#clear-url').on('click', function() {
                    delete localStorage.dbUrl;
                });
                $('#add-carbs').on('click', function() {
                    var carbs = parseInt(prompt('How many carbs?'), 10);
                    var now = Date.now();
                    if (carbs > 0) {
                        local.put({
                            "_id": "treatments/" + new Date(now).toISOString().replace(/\..*/, 'Z'),
                            "eventType": "Meal Bolus",
                            "created_at": new Date(now).toISOString(),
                            "date": now,
                            "enteredBy": "Nightbear Entries UI",
                            "carbs": carbs
                        }).then(
                            function() { alert('Success'); },
                            function() { alert('Failure'); }
                        );
                    }
                });
                $('#add-insulin').on('click', function() {
                    var insulin = parseInt(prompt('How much insulin?'), 10);
                    var now = Date.now();
                    if (insulin > 0) {
                        local.put({
                            "_id": "treatments/" + new Date(now).toISOString().replace(/\..*/, 'Z'),
                            "eventType": "Meal Bolus",
                            "created_at": new Date(now).toISOString(),
                            "date": now,
                            "enteredBy": "Nightbear Entries UI",
                            "insulin": insulin
                        }).then(
                            function() { alert('Success'); },
                            function() { alert('Failure'); }
                        );
                    }
                });

                document.addEventListener("visibilitychange", function() {
                    console.log('document.hidden => ' + !!document.hidden);
                    if (!document.hidden) {
                        $('#visibility').show();
                        setTimeout(function() {
                            $('#visibility').hide();
                        }, 3000);
                    }
                }, false);

                if (!localStorage.dbUrl) {
                    localStorage.dbUrl = prompt('Enter full DB URL to connect to') || '';
                }

                if (!localStorage.dbUrl) {
                    return;
                }

                console.log('App starting up');

                var local = window.localDB = new PouchDB('user_marja_' + DB_VERSION);
                var remote = window.remoteDB = new PouchDB(localStorage.dbUrl);

                /*
                local.put({
                    _id: '_design/nightbear_immutability',
                    filters: {
                        mutable_timeline: function(doc) {
                            return !!doc._id.match(/^(?:alarms|treatments)\/(.+)/);
                        }.toString(),
                        immutable_timeline: function(doc) {
                            return !!doc._id.match(/^(?!alarms|treatments).+?\/(.+)/);
                        }.toString()
                    }
                }).then(
                    function(x) {
                        console.info(x)
                    },
                    function(y) {
                        console.error(y)
                    }
                );
                return;
                */

                start_repl_DOWN();

                function start_repl_DOWN() {

                    var filterBackTo = '2016-03-13' //new Date(Date.now() - 1000 * 60 * 60).toISOString();

                    console.info('filterBackTo = ' + filterBackTo);

                    // @see http://pouchdb.com/api.html#replication
                    var replDOWN = remote.replicate.to(local, {
                        live: true,
                        retry: true,
                        filter: 'nightbear_immutability/mutable_timeline'
//                        query_params: { atOrLaterThan: filterBackTo }
                    });

                    var replDOWNStarted = Date.now();
                    replDOWN.on('change', function(info) {
                        console.info('[DOWN] SYNC', 'change', info);
                    }).on('paused', function(x) {
                        console.info('[DOWN] SYNC', 'paused', x);
                        $('#status-down').text('replication paused (took ' + (Date.now() - replDOWNStarted) + ' ms)');
                    }).on('active', function(x) {
                        console.info('[DOWN] SYNC', 'active', x);
                        replDOWNStarted = Date.now();
                        $('#status-down').text('[DOWN] replication ACTIVE');
                    }).on('denied', function(info) {
                        console.info('[DOWN] SYNC', 'denied', info);
                    }).on('complete', function(info) {
                        console.info('[DOWN] SYNC', 'complete', info);
                    }).on('error', function(err) {
                        console.info('[DOWN] SYNC', 'error', err);
                    });

                }

                start_repl_UP();

                function start_repl_UP() {

                    // @see http://pouchdb.com/api.html#replication
                    var replUP = local.replicate.to(remote, {
                        live: true,
                        retry: true,
                        filter: function(doc) {
                            return !!doc._id.match(/^(?:alarms|treatments)\/(.+)/);
                        }
                    });

                    var replUPStarted = Date.now();
                    replUP.on('change', function(info) {
                        console.info('[UP] SYNC', 'change', info);
                    }).on('paused', function(x) {
                        console.info('[UP] SYNC', 'paused', x);
                        $('#status-up').text('replication paused (took ' + (Date.now() - replUPStarted) + ' ms)');
                    }).on('active', function(x) {
                        console.info('[UP] SYNC', 'active', x);
                        replUPStarted = Date.now();
                        $('#status-up').text('[UP] replication ACTIVE');
                    }).on('denied', function(info) {
                        console.info('[UP] SYNC', 'denied', info);
                    }).on('complete', function(info) {
                        console.info('[UP] SYNC', 'complete', info);
                    }).on('error', function(err) {
                        console.info('[UP] SYNC', 'error', err);
                    });

                }

                var changes = local.changes({
                    since: 'now',
                    live: true,
                    include_docs: true
                }).on('change', function(change) {
//                    console.info('CHANGES', 'change', change);
                    render();
                }).on('complete', function(info) {
                    console.info('CHANGES', 'complete', info);
                }).on('error', function (err) {
                    console.info('CHANGES', 'error', err);
                });

                render();

                function render() {
                    console.log('rendering');
                    local.info()
                        .then(function(i) { $('#info').text(JSON.stringify(i, undefined, 4)) });
                    local.allDocs({ include_docs: true, limit: 10, descending: true, start_key: 'treatments/_' })
                        .then(function(res) {
                            $('ul').html('').append(
                                res.rows.map(function(row) {
                                    var doc = row.doc;
                                    return $('<li>').text(new Date(doc.date) +
                                        ' ' + (doc.insulin ? 'insulin = ' + doc.insulin : '') +
                                        ' ' + (doc.carbs ? 'carbs = ' + doc.carbs : '')
                                    )
                                })
                            );
                        })
                }

            });
        </script>
    </body>
</html>
