"use strict";angular.module("bearApp",["angular-gestures","n3-line-chart"]),angular.module("bearApp").service("PersistenceService",["$http","$q",function(a,b){function c(){return JSON.parse(localStorage[l]||"[]")}function d(a){return localStorage[l]=JSON.stringify(a),a}function e(){return a({method:"GET",url:k}).then(function(a){return a&&_.isArray(a.data)?a.data:[]})}function f(c){return b.all(_.chain(c).where({unpersisted:!0}).map(function(b){return a({method:"POST",url:k,data:b}).then(function(){return _.omit(b,"unpersisted")})}).value())}function g(a,b){return _.values(_.indexBy(a.concat(b),"time"))}function h(a,b){var c=_.chain(b).pluck("time").sortBy().first(1).value();return _.filter(a,function(a){return a.time>=c||a.unpersisted})}function i(){return[{time:(new Date).getTime()-0*m,sugar:10.2,carbs:0,insulin:0},{time:(new Date).getTime()-10*m,sugar:12,carbs:70,insulin:0},{time:(new Date).getTime()-15*m,sugar:8,carbs:0,insulin:7},{time:(new Date).getTime()-40*m,sugar:5.5,carbs:50,insulin:4},{time:(new Date).getTime()-50*m,sugar:8,carbs:45,insulin:0},{time:(new Date).getTime()-60*m,sugar:4.5,carbs:70,insulin:2},{time:(new Date).getTime()-70*m,sugar:18,carbs:0,insulin:0},{time:(new Date).getTime()-80*m,sugar:8,carbs:0,insulin:0},{time:(new Date).getTime()-120*m,sugar:6,carbs:0,insulin:0},{time:(new Date).getTime()-140*m,sugar:3.9,carbs:40,insulin:0},{time:(new Date).getTime()-200*m,sugar:5.4,carbs:10,insulin:1}]}var j=!1,k="/api/entries",l="bear-program",m=3e5,n=3e5,o=j?i():c(),p=function(a){return a.resolve(),a.promise}(b.defer());return window.PersistenceService={getEntries:function(){return _.map(o,function(a){return _.clone(a)})},addEntry:function(a){a=_.chain(a).pick("time","sugar","carbs","insulin").extend({unpersisted:!0}).value(),console.log("PersistenceSerice.addEntry()",a),o=g(o,[a]),j||d(o)},synchronizeWithBackend:function(){return j?p:(console.log("PersistenceSerice.synchronizeWithBackend() starting, "+o.length+" local entries"),f(o).then(function(a){return o=g(o,a),e().then(function(a){o=d(h(g(o,a),a)),console.log("PersistenceSerice.synchronizeWithBackend() done, "+o.length+" local entries")})}))},getRecentEntry:function(){return o.filter(function(a){return Math.abs(a.time-Date.now())<n})[0]}}}]),angular.module("bearApp").controller("MainCtrl",["$scope","PersistenceService",function(a,b){function c(){a.entries=b.getEntries(),a.entries=_.sortBy(a.entries,"time");var c=_.map(a.entries,function(a){return{x:new Date(a.time),value:a.sugar}});c&&(a.data=c)}function d(){a.synchronizationInProgress=!0,b.synchronizeWithBackend().then(function(){a.synchronizationInProgress=!1,c()},function(){a.synchronizationInProgress=!1,a.error=!0})}function e(){var c=b.getRecentEntry();a.entryBeingEdited=c||{time:void 0,sugar:void 0,carbs:void 0,insulin:void 0},c&&f()}function f(){window.clearTimeout(j),j=window.setTimeout(function(){a.$apply(e)},k)}function g(a,b){for(var c=[],d=Math.ceil(a/l)*l,e=b,f=d;f>=e-l;)c.push({time:f,duration:l}),f-=l;return c}function h(){var a=window.setInterval(function(){var b=$(".timeline-container"),c=$(".timeline");b.length&&c.length&&(window.clearTimeout(a),b.scrollLeft(c.width()))},10)}function i(){window.applicationCache.addEventListener("updateready",function(){window.applicationCache.status===window.applicationCache.UPDATEREADY&&window.confirm("Application update available, reload?")&&window.location.reload()},!1)}var j,k=6e4,l=36e5,m=3456e5,n=25e-6;a.SUGAR_OPTIONS=_.range(1,30.5,.5),a.CARBS_OPTIONS=_.range(5,155,5),a.INSULIN_OPTIONS=_.range(1,16,1),a.timelineStartMS=Date.now()+9e5,a.timelineEndMS=a.timelineStartMS-m,a.TIMELINE_PX_PER_MS=n,a.TIMELINE_LENGTH_MS=m,a.calendar=g(a.timelineStartMS,a.timelineEndMS),a.options={axes:{x:{key:"x",min:a.timelineEndMS+354e4,max:a.timelineStartMS,type:"date",ticks:1},y:{min:1,max:22}},series:[{y:"value",color:"#5bc0de",thickness:"2px",dotSize:"3",type:"area",striped:!1}],lineMode:"monotone",tension:.7,tooltip:{mode:"none",formatter:function(a,b){return b}},drawLegend:!1,drawDots:!0,columnsHGap:3},c(),e(),d(),h(),i(),a.saveEditedEntry=function(){a.entryBeingEdited.time||(a.entryBeingEdited.time=Date.now()),b.addEntry(a.entryBeingEdited),c(),f(),d()},a.selectEntry=function(b){var c=b.time===a.entryBeingEdited.time;a.entryBeingEdited={time:c?void 0:b.time,sugar:c?void 0:b.sugar,carbs:c?void 0:b.carbs,insulin:c?void 0:b.insulin},f()},a.addTimelineEntry=function(b){var c=$(".timeline-container").scrollLeft()+b.gesture.center.pageX,d=a.timelineEndMS+c/n,e={time:d,sugar:void 0,carbs:void 0,insulin:void 0};a.entries.push(e),a.entryBeingEdited=e}}]),angular.module("bearApp").controller("DashboardCtrl",["$scope","PersistenceService",function(a){a.number=9.4}]),angular.module("bearApp").directive("scrollSelector",function(){var a=30;return{restrict:"E",scope:{subject:"=",options:"=",decimals:"=",placeholder:"="},templateUrl:"views/scrollSelector.html",link:function(b,c,d){function e(c){c=c||b.placeholder;var d=f.find('*[data-option="'+c+'"]'),e=d.outerHeight(),g=(d.prevUntil().length+1)*e,h=f.height();f.animate({scrollTop:g-h/2-e/2+a})}var f=$(c[0]);b.property=d.property,b.update=function(a){b.subject[d.property]=b.subject[d.property]===a?void 0:a},b.$watch("subject."+d.property,e);var g=window.setInterval(function(){var a=f.find("> div");a.length&&(window.clearTimeout(g),e())},10)}}}),angular.module("bearApp").filter("timeago",function(){return function(a){if(!a)return"never";var b=Date.now();if("number"==typeof a&&"number"==typeof b){var c=(b-a)/1e3,d=[],e=60,f=3600,g=86400;if(5*e>=c)d="now";else if(60*e>c)d=Math.round(c/e)+" min";else if(24*f>c){var h=Math.round(c/f*10)/10;d=c%f===0?Math.floor(h)+" h":h+" h"}else d=7*g>c?Math.round(c/g)+(1===Math.round(c/g)?" day":" days"):new Date(a).getDate()+"."+(new Date(a).getMonth()+1)+".";return d}}});